<!-- HTML header for doxygen 1.8.20-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ParaMonte: D:/Dropbox/Projects/20180101_ParaMonte/git/src/kernel/___toBeCleared___/ParaDRAM_mod@KernelSinglChain.f90 Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="html_extra_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="https://www.cdslab.org/paramonte/" target="_blank"><img alt="Logo" src="logo.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ParaMonte
   &#160;<span id="projectnumber">1.5.1</span>
   </div>
   <div id="projectbrief">Plain Powerful Parallel Monte Carlo Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_dc43877d82dd332f9fb2071fcca799d6.html">kernel</a></li><li class="navelem"><a class="el" href="dir_200d6d2a7c1b6e12abae16aabaa5c3fe.html">___toBeCleared___</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle"><div class="title">ParaDRAM_mod@KernelSinglChain.f90</div></div>
</div><!--header-->
<div class="contents">
<a href="ParaDRAM__mod_0dKernelSinglChain_8f90.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span>submodule(<a class="code hl_namespace" href="namespaceparadram.html">paradram</a>) kernelsinglchain</div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span>  </div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span>  <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span>  </div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span>  <span class="comment">!real(RK), save, allocatable :: Chain(:,:)[:]</span></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span>  <span class="comment">!real(RK), save :: co_ProposalAccepted[*]</span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span> </div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="keyword">contains</span></div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span> </div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="comment">!****************************************************************************</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="comment">!****************************************************************************</span></div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span> </div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span>  <span class="keyword">module procedure</span> runkernelsinglchain</div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span>    </div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span>    <span class="keywordtype">use </span>misc, <span class="keywordtype">only</span>: num2str</div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span>    <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacestatistics.html">statistics</a>, <span class="keywordtype">only</span>: <a class="code hl_function" href="namespacestatistics.html#ad68af3401aa4557bfbe290649e378aaa">combinecovmean</a></div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span>    <span class="keywordtype">use </span><a class="code hl_namespace" href="namespaceconstants__mod.html">constants_mod</a>, <span class="keywordtype">only</span>: rk, ik, <a class="code hl_variable" href="namespaceconstants__mod.html#a2ce5b1495148376514698c8a6d60a820">loghuge_rk</a>, <a class="code hl_variable" href="namespaceconstants__mod.html#a08700d4bf701dda7c33df7590075d2e3">logtiny_rk</a></div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span>    <span class="keywordtype">use </span>paramonte, <span class="keywordtype">only</span>: getlogfunc_proc, getgradlogfunc_proc</div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span> </div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span> </div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span><span class="keywordtype">    real</span>(RK), <span class="keywordtype">save</span>, <span class="keywordtype">allocatable</span> :: co_CurrentAndLogFunc(:)[:]</div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span><span class="keywordtype">    real</span>(RK), <span class="keywordtype">save</span>, <span class="keywordtype">allocatable</span> :: co_ProposalAndLogFunc(:)[:]</div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span><span class="keywordtype">    real</span>(RK), <span class="keywordtype">save</span>              :: co_accr[*]</div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span>    <span class="keywordtype">logical</span> , <span class="keywordtype">save</span>              :: co_ProposalFound[*]</div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span>    <span class="keywordtype">logical</span> , <span class="keywordtype">save</span>              :: co_ProposalAccepted[*]                   <span class="comment">! indicates whether proposal has been found and transferred to the master image or not.</span></div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span>    <span class="keywordtype">logical</span> , <span class="keywordtype">save</span>              :: co_missionAccomplished[*]                <span class="comment">! when the code accomplishes the mission, it is set to .true.</span></div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span>    <span class="keywordtype">logical</span> , <span class="keywordtype">save</span>              :: co_samplerUpdateOccurred[*]</div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span>  </div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span>    <span class="keywordtype">integer(IK)</span>                 :: ndPlusOne</div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span>    <span class="keywordtype">integer(IK)</span>                 :: idelayCounter                            <span class="comment">! counter for idelayAdaptiveUpdate</span></div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span>    <span class="keywordtype">integer(IK)</span>                 :: idelayCounterUniquePoint                 <span class="comment">! counter for idelayAdaptiveUpdate, only updated when new proposals are accepted</span></div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span>    <span class="keywordtype">integer(IK)</span>                 :: stepCounter                              <span class="comment">! counter for unique sampled points, either unique or non-unique, depending on the user&#39;s choice equalSampleWeightRequested.</span></div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>    <span class="keywordtype">integer(IK)</span>                 :: nAdaptiveUpdateCounter                   <span class="comment">! counter for nAdaptiveUpdate</span></div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>    <span class="keywordtype">integer(IK)</span>                 :: ireportProgressCounter                   <span class="comment">! counter for ireportProgress</span></div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span>    <span class="keywordtype">integer(IK)</span>                 :: sampleWeightMerge                        <span class="comment">! the weight of the last MCMC sample that was written to the output file. This is needed for merging the same point that occurs as the last sample in the previous chain and the first sample in the current chain as a unique point in the output file.</span></div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>    <span class="keywordtype">integer(IK)</span>                 :: currentWinnerImageID                     <span class="comment">! winner image ID, for the current MCMC step</span></div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>    <span class="keywordtype">integer(IK)</span>                 :: WinnerImageID(idelayAdaptiveUpdate)      <span class="comment">! the ID of the image whose accepted proposal will be used</span></div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>    <span class="keywordtype">integer(IK)</span>                 :: SampleWeight(idelayAdaptiveUpdate)       <span class="comment">! the weight of an MCMC accepted point in the sample</span></div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span><span class="keywordtype">    real</span>(RK)                    :: Chain(nd,idelayAdaptiveUpdate)           <span class="comment">! nd-long random deviate array drawn initially from the Proposal distribution.</span></div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span><span class="keywordtype">    real</span>(RK)                    :: MeanAccr(idelayAdaptiveUpdate)           <span class="comment">! average acceptance rate up to the current position</span></div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span><span class="keywordtype">    real</span>(RK)                    :: LogFunc(idelayAdaptiveUpdate)            <span class="comment">! the vector of LogFunc values</span></div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span><span class="keywordtype">    real</span>(RK)                    :: uniformRnd                               <span class="comment">! used for random number generation.</span></div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span><span class="keywordtype">    real</span>(RK)                    :: sumAccr                                  <span class="comment">! This to figure out what the average acceptance ratio for the entire chain is.</span></div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span><span class="keywordtype">    real</span>(RK)                    :: logProbDiff                              <span class="comment">! difference between the current and the proposal logFunc values</span></div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>    <span class="keywordtype">integer(IK)</span>                 :: image <span class="comment">! , i</span></div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span>    </div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>    co_missionaccomplished = .false.</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>    ndplusone = nd + 1</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span> </div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>    <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(co_proposalandlogfunc)) <span class="keyword">deallocate</span>(co_proposalandlogfunc)</div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span>    <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(co_currentandlogfunc)) <span class="keyword">deallocate</span>(co_currentandlogfunc)</div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span>    <span class="keyword">allocate</span>(co_proposalandlogfunc(ndplusone)[*])</div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span>    <span class="keyword">allocate</span>(co_currentandlogfunc(ndplusone)[*])</div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>    </div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span>    <span class="keywordflow">if</span> (pd%Image%isMaster) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>    </div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>      nfuncall                  = 0     <span class="comment">! Markov Chain counter</span></div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span>      nfuncallaccepted          = 0     <span class="comment">! Markov Chain acceptance counter. 1 stands for first point (StartPoint)</span></div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>      ireportprogresscounter    = 0     <span class="comment">! nAdaptiveUpdate counter</span></div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span>      nadaptiveupdatecounter    = 0     <span class="comment">! nAdaptiveUpdate counter</span></div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span>      idelaycounter             = 0     <span class="comment">! idelayAdaptiveUpdate counter</span></div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>      idelaycounteruniquepoint  = 0     <span class="comment">! idelayAdaptiveUpdate counter, only for new points</span></div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>      sumaccr                   = 0._rk <span class="comment">! sum of acceptance rate</span></div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span>      co_accr                   = 1._rk <span class="comment">! acceptance rate</span></div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>      sampleweight              = 0</div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>      </div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span>      co_proposalandlogfunc(1:nd) = startpoint</div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>      co_proposalaccepted = .true.</div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>      co_proposalandlogfunc(ndplusone) = <a class="code hl_function" href="ParaMonte_0drunParaDRAM_8f90.html#a61612d7f17ad31a757aee8ee361f7fbd">getlogfunc</a>( nd, co_proposalandlogfunc(1:nd) )</div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>      co_currentandlogfunc = co_proposalandlogfunc</div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span> </div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span><span class="keywordflow">    end if</span></div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span>    </div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span>    sync all</div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span> </div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>    loopmarkovchain: <span class="keywordflow">do</span></div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span> </div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span>      <span class="keywordflow">if</span> (pd%Image%isMaster) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span> </div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span>        co_proposalfound = .false.</div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span>        </div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>        loopoverimages: <span class="keywordflow">do</span> image = 1, pd%numImages</div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span> </div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span>          nfuncall               = nfuncall + 1</div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>          sumaccr                = sumaccr  + co_accr[image]</div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>          idelaycounter          = idelaycounter + 1</div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>          ireportprogresscounter = ireportprogresscounter + 1</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>          </div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>          <span class="comment">! On the very first iteration, this block is (and must be) executed for image==1, since it is for the first (starting) point,</span></div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span>          <span class="comment">! which is assumed to have been accepted as the first point in the first coaaray image.</span></div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>          <span class="keywordflow">if</span> (co_proposalaccepted[image]) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span>            co_proposalfound = .true.</div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>            nfuncallaccepted = nfuncallaccepted + 1</div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span>            idelaycounteruniquepoint = idelaycounteruniquepoint + 1</div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>            currentwinnerimageid = image</div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>            <span class="keywordflow">if</span> (currentwinnerimageid==pd%Image%id) <span class="keywordflow">then</span>  <span class="comment">! Avoid remote connection for something that is available locally.</span></div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span>              co_currentandlogfunc = co_proposalandlogfunc</div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span>            <span class="keywordflow">else</span></div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span>              co_currentandlogfunc(:) = co_proposalandlogfunc(:)[currentwinnerimageid]</div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span><span class="keywordflow">            end if</span></div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span> </div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>          <span class="keywordflow">if</span> (idelaycounter==1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>            <span class="keywordflow">if</span> (co_proposalfound) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>              sampleweightmerge = 0</div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span>            <span class="keywordflow">else</span></div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>              idelaycounteruniquepoint = 1</div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span><span class="keywordflow">            end if</span></div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span>            </div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>          stepcounter = idelaycounteruniquepoint</div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span>          <span class="keywordflow">if</span> (equalsampleweightrequested) stepcounter = idelaycounter</div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span> </div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>          logfunc(stepcounter)       = co_currentandlogfunc(ndplusone)</div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>          meanaccr(stepcounter)      = sumaccr / real(nfuncall,kind=rk)</div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>          chain(1:nd,stepcounter)    = co_currentandlogfunc(1:nd)</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span>          sampleweight(stepcounter)  = sampleweight(stepcounter) + 1</div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>          winnerimageid(stepcounter) = currentwinnerimageid</div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span> </div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>          <span class="keywordflow">if</span> (idelaycounter==idelayadaptiveupdate) <span class="keywordflow">then</span> <span class="comment">! update the proposal if needed</span></div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>            <span class="keywordflow">if</span> (equalsampleweightrequested) sampleweightmerge = 0</div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>            <span class="keyword">call </span>writechainfile( sampleweightmerge, nd, stepcounter, winnerimageid(1:stepcounter), sampleweight(1:stepcounter), meanaccr(1:stepcounter), logfunc(1:stepcounter), chain(1:nd,1:stepcounter) )</div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>            sampleweightmerge = sampleweight(stepcounter)</div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span>            co_samplerupdateoccurred = nadaptiveupdatecounter&lt;nadaptiveupdate</div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span>            <span class="keywordflow">if</span> (co_samplerupdateoccurred) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span>              <span class="keyword">call </span>dosamplerupdate( nd, stepcounter, idelayadaptiveupdate, nadaptiveupdatecounter, nfuncall, sumaccr, chain(1:nd,1:stepcounter), sampleweight(1:stepcounter) )</div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>              nadaptiveupdatecounter = nadaptiveupdatecounter + 1</div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span>              <span class="comment">!call writeRestartFile()</span></div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span><span class="keywordflow">            end if</span></div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span>            sampleweight(1:stepcounter) = 0</div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span>            idelaycounteruniquepoint = 0</div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span>            idelaycounter = 0</div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span>            co_samplerupdateoccurred = .false.</div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>          </div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span>          <span class="keywordflow">if</span> ( ireportprogresscounter == ireportprogress ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>            ireportprogresscounter = 0</div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span>            <span class="keyword">call </span>reportprogress(nfuncall,nfuncallaccepted,sumaccr)</div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span><span class="keywordflow">          end if</span>      </div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span> </div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span>          <span class="keywordflow">if</span> (co_proposalfound) <span class="keywordflow">exit</span> loopoverimages</div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span> </div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span><span class="keywordflow">        end do</span> loopoverimages</div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span>        </div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span>        <span class="keywordflow">if</span> (nfuncallaccepted&gt;=chainsize) co_missionaccomplished = .true.</div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span> </div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span>        sync images(*)</div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span> </div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span> </div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span>        sync images(1)</div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span>        <span class="keywordflow">if</span> (co_proposalfound[1]) co_currentandlogfunc = co_currentandlogfunc(:)[1]</div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>        <span class="keywordflow">if</span> (co_samplerupdateoccurred[1]) <span class="keyword">call </span>getsamplerupdate()</div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span> </div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span><span class="keywordflow">      end if</span></div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span> </div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span>      <span class="keywordflow">if</span> (co_missionaccomplished[1]) <span class="keywordflow">exit</span> loopmarkovchain   <span class="comment">! we are done</span></div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span> </div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span>      <span class="keyword">call </span>getproposal(nd,co_currentandlogfunc,co_proposalandlogfunc,logprobdiff,<a class="code hl_function" href="ParaMonte_0drunParaDRAM_8f90.html#a61612d7f17ad31a757aee8ee361f7fbd">getlogfunc</a>,getgradlogfunc)</div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span>      </div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span>      <span class="comment">! ensure the new proposal logFunc does not cause overflow or underflow</span></div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span>      <span class="keywordflow">if</span> (logprobdiff&gt;<a class="code hl_variable" href="namespaceconstants__mod.html#a2ce5b1495148376514698c8a6d60a820">loghuge_rk</a>) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span>        co_accr = 1._rk</div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>      <span class="keywordflow">elseif</span> (logprobdiff&lt;<a class="code hl_variable" href="namespaceconstants__mod.html#a08700d4bf701dda7c33df7590075d2e3">logtiny_rk</a>) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span>        co_accr = 0._rk</div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>        co_accr = min( 1._rk , exp(logprobdiff) )</div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span><span class="keywordflow">      end if</span></div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>      </div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>      <span class="keyword">call </span>random_number(uniformrnd) <span class="comment">! Now accept the new Proposal with probability co_accr:</span></div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>      co_proposalaccepted = uniformrnd&lt;co_accr</div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>      <span class="comment">!critical</span></div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>      <span class="comment">!  write(*,*) PD%Image%id, co_ProposalAccepted, uniformRnd, co_accr</span></div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>      <span class="comment">!  write(*,*) PD%Image%id, co_CurrentAndLogFunc</span></div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span>      <span class="comment">!  write(*,*) PD%Image%id, co_ProposalAndLogFunc</span></div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span>      <span class="comment">!end critical</span></div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span> </div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span>      <span class="keywordflow">if</span> (pd%Image%isMaster) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span>        <span class="comment">!read(*,*)</span></div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span>        sync images(*)</div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span>        sync images(1)</div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span><span class="keywordflow">      end if</span></div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span> </div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>      cycle loopmarkovchain</div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span>    </div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span><span class="keywordflow">    end do</span> loopmarkovchain</div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span>    </div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span>    sync all</div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span> </div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span>  <span class="keyword">end </span>procedure runkernelsinglchain</div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span> </div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span><span class="comment">!****************************************************************************</span></div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span><span class="comment">!****************************************************************************</span></div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span> </div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span><span class="keyword">end </span>submodule KernelSinglChain</div>
<div class="ttc" id="aParaMonte_0drunParaDRAM_8f90_html_a61612d7f17ad31a757aee8ee361f7fbd"><div class="ttname"><a href="ParaMonte_0drunParaDRAM_8f90.html#a61612d7f17ad31a757aee8ee361f7fbd">getlogfunc</a></div><div class="ttdeci">real(rk) function getlogfunc(ndim, Point)</div><div class="ttdef"><b>Definition:</b> <a href="ParaMonte_0drunParaDRAM_8f90_source.html#l00196">ParaMonte@runParaDRAM.f90:197</a></div></div>
<div class="ttc" id="anamespaceconstants__mod_html"><div class="ttname"><a href="namespaceconstants__mod.html">constants_mod</a></div><div class="ttdoc">This module contains the mathematical and programming constants.</div><div class="ttdef"><b>Definition:</b> <a href="Constants__mod_8f90_source.html#l00046">Constants_mod.f90:46</a></div></div>
<div class="ttc" id="anamespaceconstants__mod_html_a08700d4bf701dda7c33df7590075d2e3"><div class="ttname"><a href="namespaceconstants__mod.html#a08700d4bf701dda7c33df7590075d2e3">constants_mod::logtiny_rk</a></div><div class="ttdeci">real(rk), parameter logtiny_rk</div><div class="ttdoc">log of the smallest number of kind RK</div><div class="ttdef"><b>Definition:</b> <a href="Constants__mod_8f90_source.html#l00098">Constants_mod.f90:98</a></div></div>
<div class="ttc" id="anamespaceconstants__mod_html_a2ce5b1495148376514698c8a6d60a820"><div class="ttname"><a href="namespaceconstants__mod.html#a2ce5b1495148376514698c8a6d60a820">constants_mod::loghuge_rk</a></div><div class="ttdeci">real(rk), parameter loghuge_rk</div><div class="ttdoc">log of the largest number of kind RK</div><div class="ttdef"><b>Definition:</b> <a href="Constants__mod_8f90_source.html#l00097">Constants_mod.f90:97</a></div></div>
<div class="ttc" id="anamespaceparadram_html"><div class="ttname"><a href="namespaceparadram.html">paradram</a></div><div class="ttdef"><b>Definition:</b> <a href="______toBeCleared_______2ParaDRAM__mod_8f90_source.html#l00001">ParaDRAM_mod.f90:1</a></div></div>
<div class="ttc" id="anamespacestatistics_html"><div class="ttname"><a href="namespacestatistics.html">statistics</a></div><div class="ttdef"><b>Definition:</b> <a href="______toBeCleared_______2Statistics__mod_8f90_source.html#l00001">Statistics_mod.f90:1</a></div></div>
<div class="ttc" id="anamespacestatistics_html_ad68af3401aa4557bfbe290649e378aaa"><div class="ttname"><a href="namespacestatistics.html#ad68af3401aa4557bfbe290649e378aaa">statistics::combinecovmean</a></div><div class="ttdeci">subroutine combinecovmean(nd, npA, MeanA, CovMatA, npB, MeanB, CovMatB, Mean, CovMat)</div><div class="ttdef"><b>Definition:</b> <a href="______toBeCleared_______2Statistics__mod_8f90_source.html#l00641">Statistics_mod.f90:642</a></div></div>
</div><!-- fragment --></div><!-- contents -->
    <!-- start footer part -->
    <hr class="footer"/>
    <div style="text-align:center">
        <p>
            <a href="https://www.cdslab.org/paramonte"><b>ParaMonte: Plain Powerful Parallel Monte Carlo Library</b></a>&nbsp;
            &copy; Copyright 2020, <a href="https://www.cdslab.org" target="_blank"><b>The Computational Data Science Lab</b></a>
            <br/>
        </p>
    </div>
    <address class="footer">
        <small>
            Generated on Thu Aug 19 2021 18:26:37 for ParaMonte by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a>
            <!--
            1.9.2
            -->
        </small>
    </address>
    <!-- Start of statc -->
    <div style="color: #ffffff; float: none; width: 100%;">
        <span style="font-size:0.8em">
        <!--visitor count: -->
            <script type="text/javascript">
                var sc_project=12178963; 
                var sc_invisible=1; 
                var sc_security="e0dfe0f9"; 
                var sc_text=3; 
                var scJsHost = "https://";
                document.write("<sc"+"ript type='text/javascript' src='" +
                scJsHost+
                "statcounter.com/counter/counter.js'></"+"script>");
            </script>
        </span>
    </div>
</body>
</html>
